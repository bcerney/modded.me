#!/bin/bash -xe

exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1
yum -y update

# https://gist.github.com/npearce/6f3c7826c7499587f00957fee62f8ee9
yum install -y docker git vim
service docker start

# docker-composes
sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Mount EBS volume
# TODO handle /etc/fstab update to mount on reboot
# https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-using-volumes.html
# TODO: don't want to reformt w/ snapshots, need to check?
#mkfs -t xfs /dev/sdb
mkdir /data
mount /dev/sdb /data
lsblk
mkdir -p /data/postgres_data


GITLAB_TOKEN=$(aws ssm get-parameters --names "gitlab-api-token" --with-decryption --query Parameters[*].Value --region us-east-1 --output text)

git clone https://oauth2:$GITLAB_TOKEN@gitlab.com/bcerney/django-playground.git
cd django-playground

# sed will replace branch with $CI_COMMIT_REF_SLUG
git checkout BRANCH_TO_CHECKOUT

POSTGRES_DB=$(aws ssm get-parameters --names "/test/postgres-db" --query Parameters[*].Value --region us-east-1 --output text)
POSTGRES_USER=$(aws ssm get-parameters --names "/test/postgres-user" --query Parameters[*].Value --region us-east-1 --output text)
POSTGRES_PASSWORD=$(aws ssm get-parameters --names "/test/postgres-password" --with-decryption --query Parameters[*].Value --region us-east-1 --output text)

cat > .env <<EOL
ENV=test

POSTGRES_DB=${POSTGRES_DB}
POSTGRES_USER=${POSTGRES_USER}
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}

EOL

cd dj_play/dj_play/

SECRET_KEY=$(aws ssm get-parameters --names "/test/secret-key" --with-decryption --query Parameters[*].Value --region us-east-1 --output text)
DATABASE_URL=$(aws ssm get-parameters --names "/test/database-url" --with-decryption --query Parameters[*].Value --region us-east-1 --output text)

cat > .env <<EOL
SECRET_KEY=${SECRET_KEY}
DATABASE_URL=${DATABASE_URL}

EOL

cd ../..

docker login -u bcerney -p $GITLAB_TOKEN registry.gitlab.com
docker-compose -f docker-compose.test.yml up -d
